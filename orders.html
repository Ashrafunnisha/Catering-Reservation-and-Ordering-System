<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incoming Orders - Hasina Foods</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <div class="nav-brand">Hasina Foods</div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-item">Products</a>
                <a href="#" class="nav-item active">Orders</a>
                <a href="#" id="logoutBtn" class="nav-item" style="color: var(--error-color);">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container" style="padding: 2rem 0;">
        <h2>Incoming Orders</h2>
        <div id="loading" style="margin-top: 1rem;">Loading orders...</div>

        <div id="ordersList" style="margin-top: 1rem;">
            <!-- Orders will be injected here -->
        </div>

        <div id="emptyState" style="text-align: center; padding: 4rem; display: none;">
            <p>No orders received yet.</p>
        </div>
    </div>

    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/db.js?v=2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            Auth.checkAuth('admin');

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.addEventListener('click', Auth.logout);

            const ordersList = document.getElementById('ordersList');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');

            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const orders = await DB.getAdminOrders(user.uid);
                        loading.style.display = 'none';

                        if (orders.length === 0) {
                            emptyState.style.display = 'block';
                        } else {
                            // Sort by date desc locally since we avoided index requirement
                            orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                            orders.forEach(order => {
                                const card = document.createElement('div');
                                card.className = 'card';
                                card.style.marginBottom = '1rem';

                                const date = new Date(order.createdAt).toLocaleString();
                                const total = formatCurrency(order.totalAmount);

                                let itemsHtml = '<ul style="margin: 0.5rem 0 0.5rem 1.5rem;">';
                                order.items.forEach(item => {
                                    itemsHtml += `<li>${item.quantity}x ${item.name} (${formatCurrency(item.price)})</li>`;
                                });
                                itemsHtml += '</ul>';

                                card.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                                        <strong>Order #${order.id.slice(0, 8)}</strong>
                                        <span class="${order.status === 'PENDING' ? 'text-secondary' : 'text-success'}">${order.status}</span>
                                    </div>
                                    <p class="text-secondary" style="font-size: 0.9rem;">From: ${order.customerName} | ${date}</p>
                                    <div style="margin: 1rem 0;">
                                        <strong>Items:</strong>
                                        ${itemsHtml}
                                    </div>
                                    <div style="text-align: right; font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">
                                        Total: ${total}
                                    </div>
                                    <div style="margin-top: 1rem; text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end;">

                                        ${order.status === 'PENDING' ? `
                                            <button class="btn btn-primary" onclick="updateStatus('${order.id}', 'ACCEPTED')">Accept</button>
                                            <button class="btn btn-secondary" onclick="updateStatus('${order.id}', 'REJECTED')" style="border-color: var(--error-color); color: var(--error-color);">Reject</button>
                                        ` : order.status === 'ACCEPTED' ? `
                                            <span style="margin-right: 1rem; padding: 0.5rem; color: var(--success-color);">Accepted</span>
                                            <button class="btn btn-primary" onclick="updateStatus('${order.id}', 'PROCESSING')">Mark Processing</button>
                                        ` : order.status === 'PROCESSING' ? `
                                            <span style="margin-right: 1rem; padding: 0.5rem; color: var(--primary-color);">Processing</span>
                                            <button class="btn btn-success" style="background-color: var(--success-color); border: none;" onclick="updateStatus('${order.id}', 'COMPLETED')">Mark Completed</button>
                                        ` : `
                                            <span style="font-weight: bold; padding: 0.5rem;">Status: ${order.status}</span>
                                        `}
                                    </div>
                                    </div>
                                `;
                                ordersList.appendChild(card);
                            });
                        }
                    } catch (error) {
                        loading.textContent = "Error loading orders: " + error.message;
                        Logger.error('Order load failed', error);
                    }
                }
            });

            window.updateStatus = async (orderId, status) => {
                if (!confirm(`Mark this order as ${status}?`)) return;
                try {
                    await DB.updateOrderStatus(orderId, status);
                    window.location.reload();
                } catch (e) {
                    alert("Failed to update: " + e.message);
                }
            };
        });
    </script>
</body>

</html>